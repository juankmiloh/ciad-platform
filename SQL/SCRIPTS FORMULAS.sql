-- CONSULTA PARA ENCONTRAR LA TABLA CORRESPONDIENTE AL FORMATO DE TARIFAS | SE BUSCA POR NOMBRE DE CAMPO(T's)
SELECT * FROM all_tab_columns
WHERE COLUMN_NAME LIKE '%1673%';

-- CONSULTA PARA BUSCAR UNA TABLA EN UN ESQUEMA DE BASE DE DATOS
SELECT * FROM all_tab_columns
WHERE TABLE_NAME LIKE '%FORMATO7%';

-- CONSULTA PARRILLA COSTO UNITARIO
SELECT FT7.* FROM -- TRAEMOS LOS DATOS QUE NO TUVIERON CORRECCIÓN
( -- TRAEMOS LOS DATOS DE FT7 (DATOS QUE NO TUVIERON CORRECCIÓN Y LOS QUE TIENEN CORRECCIÓN DE FT8)
    SELECT * FROM ENERGIA_CREG_015.CAR_COSTO_UNITARIO_119_UR
    WHERE 
        (ID_EMPRESA = :EMPRESA_ARG OR 0 = :EMPRESA_ARG)
        AND (CAR_T1669_ID_MERCADO = :MERCADO_ARG OR 0 = :MERCADO_ARG)
        AND CAR_CARG_ANO = :ANIO_ARG
        AND CAR_CARG_PERIODO = :MES_ARG
        AND CAR_T1676_ANIO_CORREG IS NULL
)FT7
LEFT JOIN -- LE QUITAMOS LOS DATOS DE FT8 (DATOS CORREGIDOS)
(
    SELECT * FROM ENERGIA_CREG_015.CAR_COSTO_UNITARIO_119_UR
    WHERE 
        (ID_EMPRESA = :EMPRESA_ARG OR 0 = :EMPRESA_ARG)
        AND (CAR_T1669_ID_MERCADO = :MERCADO_ARG OR 0 = :MERCADO_ARG)
        AND CAR_CARG_ANO = :ANIO_ARG
        AND CAR_CARG_PERIODO = :MES_ARG
        AND CAR_T1676_ANIO_CORREG IS NOT NULL
)F8
ON FT7.CAR_T1669_ID_MERCADO = F8.CAR_T1669_ID_MERCADO
AND FT7.ID_EMPRESA = F8.ID_EMPRESA
AND FT7.CAR_T1669_NT_PROP = F8.CAR_T1669_NT_PROP
AND FT7.CAR_CARG_ANO = F8.CAR_CARG_ANO
AND FT7.CAR_CARG_PERIODO = F8.CAR_CARG_PERIODO
WHERE (FT7.CAR_T1676_ANIO_CORREG IS NULL AND F8.CAR_T1676_ANIO_CORREG IS NULL)
UNION -- LE AGREGAMOS LOS DATOS DE FT8
(
    SELECT * FROM ENERGIA_CREG_015.CAR_COSTO_UNITARIO_119_UR
    WHERE 
        (ID_EMPRESA = :EMPRESA_ARG OR 0 = :EMPRESA_ARG)
        AND (CAR_T1669_ID_MERCADO = :MERCADO_ARG OR 0 = :MERCADO_ARG)
        AND CAR_CARG_ANO = :ANIO_ARG
        AND CAR_CARG_PERIODO = :MES_ARG
        AND CAR_T1676_ANIO_CORREG IS NOT NULL
); --FT8


-- CONSULTA PARA TRAER CANTIDAD DE DATOS CORREGIDOS Y NO CORREGIDOS
SELECT ID_EMPRESA, CAR_T1669_ID_MERCADO, CAR_T1669_NT_PROP, COUNT(*) FROM ENERGIA_CREG_015.CAR_COSTO_UNITARIO_119_UR
WHERE 
    --ID_EMPRESA = 2322
    --AND CAR_T1669_ID_MERCADO = 173
    CAR_CARG_ANO = 2020
    AND CAR_CARG_PERIODO = 2
GROUP BY ID_EMPRESA, CAR_T1669_ID_MERCADO, CAR_T1669_NT_PROP
ORDER BY CAR_T1669_NT_PROP;


-- CONSULTA PARA HHALLAR VALOR DEL COMPONENTE G
SELECT
    (T10.C12_C4 + T9.C13_C15 + T10.C14_C6 + T9.C15_C16) AS C16_DCR,
    (LEAST(1,((T9.C1_C7 + T10.C2_C2) / (T10.C12_C4 + T9.C13_C15 + T10.C14_C6 + T9.C15_C16)))) AS C17_QC,
    ((T9.C4_C8 + T9.C6_C3) / (T9.C1_C7 + T10.C2_C2)) AS C22_PC,
    (T9.C1_C7 - LEAST(1,((T9.C1_C7 + T10.C2_C2) / (T10.C12_C4 + T9.C13_C15 + T10.C14_C6 + T9.C15_C16)))) AS C18_QB,
    (T9.C8_C6 / T9.C7_C5) AS C23_PB,
    (T9.C19_C9 + T9.C20_C10) AS C21_QAGD,
    (T13.C9_C1 + T9.C10_C4) AS C11_MCAPLICADO,
    (LEAST(1,((T9.C1_C7 + T10.C2_C2) / (T10.C12_C4 + T9.C13_C15 + T10.C14_C6 + T9.C15_C16))) * ((C25_C14 * ((T9.C4_C8 + T9.C6_C3) / (T9.C1_C7 + T10.C2_C2))) + (1 - C25_C14) * (T13.C9_C1 + T9.C10_C4))) AS C29_GCONTRATOS,
    ((1 - (LEAST(1,((T9.C1_C7 + T10.C2_C2) / (T10.C12_C4 + T9.C13_C15 + T10.C14_C6 + T9.C15_C16)))) - (T9.C19_C9 + T9.C20_C10)) * (T9.C8_C6 / T9.C7_C5)) AS C30_GBOLSA,
    ((LEAST(1,((T9.C1_C7 + T10.C2_C2) / (T10.C12_C4 + T9.C13_C15 + T10.C14_C6 + T9.C15_C16))) * ((C25_C14 * ((T9.C4_C8 + T9.C6_C3) / (T9.C1_C7 + T10.C2_C2))) + (1 - C25_C14) * (T13.C9_C1 + T9.C10_C4))) + ((1 - (LEAST(1,((T9.C1_C7 + T10.C2_C2) / (T10.C12_C4 + T9.C13_C15 + T10.C14_C6 + T9.C15_C16)))) - (T9.C19_C9 + T9.C20_C10)) * (T9.C8_C6 / T9.C7_C5)) + T9.C24_C13 + T9.C26_C11) AS C28_CG
FROM
(
    SELECT
        CAR_T1671_DMRE AS C12_C4,
        CAR_T1671_PRRE AS C14_C6,
        CAR_T1671_ECC AS C2_C2,
        CAR_T1671_VECC AS C5_C3
    FROM ENERGIA_CREG_015.CAR_T1671_INFORMACION_ASIC_LAC
    WHERE CAR_CARG_PERIODO = 2
    AND CAR_CARG_ANO = 2020
    AND CAR_T1671_ID_EMPRESA = 2103
) T10,
(
    SELECT 
        CAR_1672_ECC AS C1_C7,
        CAR_1672_AECC AS C3_C2,
        CAR_1672_VECC AS C4_C8,
        CAR_1672_CB AS C7_C5,
        CAR_1672_VCB AS C8_C6,
        CAR_1672_ADMRE_G AS C13_C15,
        CAR_1672_APRRE_G AS C15_C16,
        CAR_1672_AVECC AS C6_C3,
        CAR_1672_AGPE AS C19_C9,
        CAR_1672_GD AS C20_C10,
        CAR_1672_AJ AS C24_C13,
        CAR_1672_ALFA AS C25_C14,
        CAR_1672_GTR AS C26_C11,
        CAR_1672_CFNC AS C27_C12,
        CAR_1672_AMC AS C10_C4
    FROM
        ENERGIA_CREG_015.CAR_VAR_COSTO_UNT_PS_CU_119_UR
    WHERE
        CAR_CARG_ANO = 2020
        AND CAR_CARG_PERIODO = 2
        AND ID_EMPRESA = 2103
        AND CAR_1672_ID_MERCADO = 176
) T9,
(
SELECT
    CAR_T1673_MC AS C9_C1
FROM ENERGIA_CREG_015.CAR_INFORMACION_GENERAL
    WHERE
        CAR_CARG_ANO = 2020
        AND CAR_CARG_PERIODO = 2
)T13;